name: SonarQube
on:
  push:
    branches:
      - develop
  pull_request:
jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

      # Set up Docker Compose
      - name: Set up Docker Compose
        uses: ndeloof/install-compose-action@v0.0.1
        with:
          version: v2.10.2

      # Create required .env file
      - name: Create environment file
        run: |
          mkdir -p backend/dotenv_files
          echo "DEBUG=1" > backend/dotenv_files/.env
          echo "SECRET_KEY=github-actions-test-key" >> backend/dotenv_files/.env
          echo "ALLOWED_HOSTS=*" >> backend/dotenv_files/.env
          # Use SQLite instead of PostgreSQL
          echo "DATABASE_URL=sqlite:///db.sqlite3" >> backend/dotenv_files/.env
          echo "DATABASE_NAME=db.sqlite3" >> backend/dotenv_files/.env
          # Explicitly disable PostgreSQL
          echo "USE_POSTGRES=0" >> backend/dotenv_files/.env

      # Start just the backend container with SQLite
      - name: Start backend service
        run: |
          # Skip starting the PostgreSQL container
          docker-compose up -d backend
          docker-compose ps
          docker-compose logs backend
          # Check if backend is running (using 'running' instead of 'Up')
          if ! docker-compose ps backend | grep -q "running"; then
            echo "Backend container failed to start"
            exit 1
          fi

      # Run tests with coverage
      - name: Run tests with coverage
        run: |
          docker-compose exec -T backend bash -c "coverage run --source='.' manage.py test"
          docker-compose exec -T backend coverage xml
          mkdir -p coverage-reports
          docker cp $(docker-compose ps -q backend):/code/coverage.xml ./coverage-reports/

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
